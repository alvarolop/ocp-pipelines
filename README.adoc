= OpenShift Pipelines
Álvaro López Medina <alopezme@redhat.com>
v1.0, 2023-03
// Metadata
:description: This repository contains resources to deploy and test Openshift Pipelines
:keywords: openshift, pipelines, tekton, ci, red hat
// Create TOC wherever needed
:toc: macro
:sectanchors:
:sectnumlevels: 2
:sectnums: 
:source-highlighter: pygments
:imagesdir: images
// Start: Enable admonition icons
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
ifndef::env-github[]
:icons: font
endif::[]

This repository contains resources to deploy and practice Openshift Pipelines.

// Create the Table of contents here
toc::[]

== Introduction

*Red Hat OpenShift Pipelines* is a cloud-native, continuous integration and continuous delivery (CI/CD) solution based on Kubernetes resources. It uses Tekton building blocks to automate deployments across multiple platforms by abstracting away the underlying implementation details. 

**What do we understand as Cloud Native CI/CD?**

* *Containers*: Built for container apps and runs on Kubernetes.
* *Serverless*: Runs serverless with no CI/CD engine to manage and maintain.
* *DevOps*: Designed with microservices and distributed teams in mind.


To get more details, you can check the https://docs.openshift.com/container-platform/4.12/cicd/pipelines/understanding-openshift-pipelines.html[official documentation].


== Installation of the operator

Installing the operator is as easy as creating a Subscription in the project `openshift-operators`. The Pipelines Operator is installed for All namespaces: 

[source, bash]
----
oc apply -f 00-installation/1-subscription.yaml
----

In order to split the pipelines executing from the operator itself, we will create another namespace where the pipelines will be executed:

[source, bash]
----
cat 00-installation/2-project-template.yaml | \
PIPELINES_PROJECT=pipelines-test \
envsubst > 00-installation/2-project.yaml

oc apply -f 00-installation/2-project.yaml
----


== Useful Tasks for the pipelines

This section contains several tasks that can be useful for the pipelines. 


.*List files in the workspace*
[source, bash]
----
cat 10-tasks/1-list-files-template.yaml | \
PIPELINES_PROJECT=pipelines-test \
envsubst > 10-tasks/1-list-files.yaml

oc apply -f 10-tasks/1-list-files.yaml
----






== Secrets for authentication

In many practical use cases, you might need to pull from private Git repositories or might need to push to an external container registry such as Quay.io. In this section, we will summarize how to create the `Secrets` to configure all the credentials.

=== Red Hat Registry

To use the `registry.redhat.io` registry, you have to have a Red Hat login. To consume container images from registry.redhat.io in shared environments such as OpenShift, it is recommended for an administrator to use a Registry Service Account, also referred to as authentication tokens, in place of an individual's Customer Portal credentials.

The management of Service Accounts is available via the https://access.redhat.com/terms-based-registry/#/[Registry Service Account management application].


[source, yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: $SECRET_NAME
data:
  .dockerconfigjson: $DOCKER_CONFIG_FILE_CONTENT
type: kubernetes.io/dockerconfigjson
----

Once you create the file with its contents, you can apply it to the cluster like this:
[source, bash]
----
oc apply -n pipelines-test -f secrets/rh-registry-sa.yaml
----

For more information, check the full https://access.redhat.com/RegistryAuthentication[KCS article].

=== Git repository

To clone a private repository in the pipeline, the `pipeline` Service Account will need to be able to authenticate against the repository. There are basically two main options to get this authentication: Using a username+token (Or a PAT if using GitHub) or using an SSH private key. 

.*Option 1: Create Secret with SSH Private Key*
[source, bash]
----
oc create secret generic git-ssh-key-secret --type=kubernetes.io/ssh-auth --from-file=ssh-privatekey=$LOCATION_PRIVATE_KEY -n pipelines-test
oc annotate secret git-ssh-key-secret tekton.dev/git-0="$GIT_PRIVATE_URL"
oc secrets link pipeline git-ssh-key-secret
----

.*Option 2: Create Secret with GitHub PAT token*
[source, bash]
----
oc create secret generic gh-pat-secret \
    --type=kubernetes.io/basic-auth \
    --from-literal=username=$GITHUB_USERNAME \
    --from-literal=password=$GITHUB_PAT
oc annotate secret gh-pat-secret tekton.dev/git-0="$GIT_PRIVATE_URL"
oc secrets link pipeline gh-pat-secret
----

For more information about the PAT creation and configuration, you can follow the instructions that we have in the following https://rhte2023-argo-rollouts.github.io/redhat-workshop-deployment-strategies/redhat-workshop-deployment-strategies/01-setup.html#_configure_your_github_token[workshop guidelines].


=== Quay Robot Account

Robot accounts are a way to access repositories without requiring a human user account. A robot account has its own credentials, generated by Quay and linked to an Organization. To create a Robot Account and get its credentials, you have to access the Quay web console. For this repository, we are going to use my personal Quay organization, which is located at: https://quay.io/user/alopezme. 

image::quay-robot-accounts-dashboard.png[]

Using an admin account, you can access the organization, go to the Robot Accounts section and click on `Create Robot Account`. After creating the Account, click on it to directly download the Kubernetes secret definition that you have to apply in your namespace.

Once you create the file with its contents, you can apply it to the cluster like this:
[source, bash]
----
oc apply -n pipelines-test -f secrets/quay-alopezme-pull-secret.yaml
----

For more information, you can access the https://access.redhat.com/documentation/en-us/red_hat_quay/3.8/html/use_red_hat_quay/use-quay-manage-repo[documentation] of the on-premise installation of Quay.


:sectnums!:
== Annex A: Tutorial

If you want a tutorial to learn Openshift Pipelines, I recommend you this https://redhat-scholars.github.io/tekton-tutorial/tekton-tutorial/index.html[tutorial] from Red Hat Scholars.

